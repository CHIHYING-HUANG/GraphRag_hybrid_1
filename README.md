# ğŸ”¬ Corpus Graph RAG ç³»çµ±

> **æ··åˆæª¢ç´¢å¢å¼·ç”Ÿæˆç³»çµ±**  
> çµåˆå‘é‡æª¢ç´¢ã€çŸ¥è­˜åœ–è­œèˆ‡ LLMï¼Œå¯¦ç¾é«˜ç²¾æº–åº¦çš„å¤šè·³å•ç­”

[![FastAPI](https://img.shields.io/badge/FastAPI-0.100+-green.svg)](https://fastapi.tiangolo.com/)
[![LangGraph](https://img.shields.io/badge/LangGraph-Latest-blue.svg)](https://langchain-ai.github.io/langgraph/)
[![Python](https://img.shields.io/badge/Python-3.9+-blue.svg)](https://www.python.org/)

---

## ğŸ“– ç›®éŒ„

- [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹è‰²](#æ ¸å¿ƒç‰¹è‰²)
- [ç³»çµ±æ¶æ§‹](#ç³»çµ±æ¶æ§‹)
- [è©³ç´°æµç¨‹èªªæ˜](#è©³ç´°æµç¨‹èªªæ˜)
- [å¿«é€Ÿé–‹å§‹](#å¿«é€Ÿé–‹å§‹)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [è©•ä¼°ç³»çµ±](#è©•ä¼°ç³»çµ±)
- [æŠ€è¡“æ£§](#æŠ€è¡“æ£§)
- [å°ˆæ¡ˆçµæ§‹](#å°ˆæ¡ˆçµæ§‹)

---

## ğŸŒŸ ç³»çµ±æ¦‚è¿°

**Corpus Graph RAG** æ˜¯ä¸€å€‹å…ˆé€²çš„å•ç­”ç³»çµ±ï¼Œå°ˆç‚ºè™•ç†**è¤‡é›œå¤šè·³æ¨ç†å•é¡Œ**è€Œè¨­è¨ˆã€‚ç³»çµ±æ¡ç”¨æ··åˆæª¢ç´¢ç­–ç•¥ï¼Œçµåˆï¼š

- ğŸ” **å‘é‡æª¢ç´¢** (Semantic Search)
- ğŸ•¸ï¸ **çŸ¥è­˜åœ–è­œæª¢ç´¢** (Graph Traversal)
- ğŸ§  **å¤§å‹èªè¨€æ¨¡å‹æ¨ç†** (LLM Reasoning)

### é©ç”¨å ´æ™¯

- âœ… å¤šè·³å•ç­” (Multi-hop QA)ï¼šéœ€è¦è·¨å¤šç¯‡æ–‡æª”æ¨ç†
- âœ… é—œä¿‚æ¨ç†ï¼šå¦‚ã€ŒPeter çš„ç¹¼çˆ¶æ˜¯èª°ï¼Ÿã€
- âœ… æ•¸å€¼æ¨ç†ï¼šå¦‚ã€Œå“ªç¨®ç¨»ç±³æœ‰8æˆæ¾±ç²‰ä¸æ˜¯ç›´éˆï¼Ÿã€
- âœ… å¯¦é«”å°å‘å•ç­”ï¼šéœ€è¦ç²¾ç¢ºå¯¦é«”åŒ¹é…

---

## ğŸ¯ æ ¸å¿ƒç‰¹è‰²

### 1. **åœ–è­œæ“´å±•æª¢ç´¢ (Graph-Guided Retrieval Expansion)**
å‚³çµ± RAG åƒ…é å‘é‡ç›¸ä¼¼åº¦ï¼Œå®¹æ˜“éŒ¯å¤±é—œéµæ–‡æª”ã€‚æœ¬ç³»çµ±é€éçŸ¥è­˜åœ–è­œã€Œé †è—¤æ‘¸ç“œã€ï¼š

```
åˆå§‹æª¢ç´¢ â†’ æ‰¾åˆ° "äººç‰©A" ç›¸é—œæ–‡æª”
    â†“
åœ–è­œæ“´å±• â†’ ç™¼ç¾ A â†’ B â†’ C çš„é—œä¿‚éˆ
    â†“
å¯¦é«”æª¢ç´¢ â†’ è£œå……æª¢ç´¢ "äººç‰©C" æ–‡æª” âœ…
```

**æ•ˆæœæå‡**ï¼šPartial Hit Rate **86.8% â†’ 93%+**

### 2. **æŸ¥è©¢æ“´å±• (Query Expansion)**
å°‡å–®ä¸€å•é¡Œæ‹†è§£ç‚ºå¤šå€‹è¦–è§’ï¼Œæå‡å¬å›ç‡ï¼š

```
åŸå•é¡Œ: "äººç‰©A çš„ç¹¼çˆ¶æ˜¯èª°ï¼Ÿ"
    â†“
æ“´å±•ç‚º:
  - äººç‰©A çš„æ¯è¦ªæ˜¯èª°ï¼Ÿ
  - äººç‰©B çš„ä¸ˆå¤«æ˜¯èª°ï¼Ÿ
  - äººç‰©C èˆ‡èª°æœ‰ç¹¼å­é—œä¿‚ï¼Ÿ
```

### 3. **LLM é‡æ’åº (Listwise Reranking)**
ä½¿ç”¨ GPT-4o-mini å° 20-30 ç¯‡å€™é¸æ–‡æª”é€²è¡Œèªç¾©æ’åºï¼Œé¸å‡ºæœ€ç›¸é—œçš„ Top-5ã€‚

### 4. **å¼·åŒ–æ¨ç† Prompt**
æ”¯æ´**å¤šæ­¥é©Ÿæ¨ç†**èˆ‡**æ•¸å€¼è¨ˆç®—**ï¼š

- é—œä¿‚éˆæ¨ç† (Aâ†’Bâ†’C)
- ç™¾åˆ†æ¯”äº’è£œè½‰æ› (80% éç›´éˆ = 20% ç›´éˆ)
- è·¨æ–‡æª”è³‡è¨Šæ•´åˆ

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ¶å•é¡Œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ”„ Query Expansion (LLM)          â”‚
         â”‚   åŸå•é¡Œ â†’ 3å€‹æ“´å±•æŸ¥è©¢                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ” Vector Retrieval (ChromaDB)    â”‚
         â”‚   ç”¨3å€‹æŸ¥è©¢æ‰¾ 30ç¯‡å€™é¸æ–‡æª”/æŸ¥è©¢         â”‚
         â”‚   (Top-30 Initial Candidates)       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ•¸ï¸ Graph Expansion (Neo4j)        â”‚
         â”‚   å¾æ–‡æª”æå– Top-5 å¯¦é«”                â”‚
         â”‚   â†“                                 â”‚
         â”‚   æ¯å€‹å¯¦é«”æ‰¾ 3 å€‹é„°å±… (Neighbors)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ” Entity-based Retrieval         â”‚
         â”‚   ç”¨åœ–è­œç™¼ç¾çš„å¯¦é«”è£œå……æª¢ç´¢               â”‚
         â”‚   (Top-5 æ“´å±•å¯¦é«” x 2 ç¯‡æ–‡æª”/å¯¦é«”)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ“Š LLM Reranking (GPT-4o-mini)    â”‚
         â”‚   å¾æ‰€æœ‰å€™é¸æ–‡æª” (Max 30+) é¸å‡º Top-5   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ•¸ï¸ Graph Retrieval (Direct)       â”‚
         â”‚   ç›´æ¥å¾å•é¡Œæå–å¯¦é«” (Max 3)           â”‚
         â”‚   æŸ¥è©¢é—œä¿‚ (Max 10/Entity)           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ğŸ§  Answer Generation (LLM)        â”‚
         â”‚   Context: Top-5 Docs + Graph Rels  â”‚
         â”‚   åŸ·è¡Œå¤šæ­¥æ¨ç†èˆ‡æ•¸å€¼è¨ˆç®—                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  âœ… æœ€çµ‚ç­”æ¡ˆ
```

### é—œéµæª”æ¡ˆè·è²¬ (File Responsibilities)

| è·¯å¾‘ (Path) | æª”æ¡ˆ (File) | è·è²¬ (Responsibility) |
| :--- | :--- | :--- |
| `app/services/rag/` | **`graph_rag.py`** | **ç¸½æŒ‡æ® (Orchestrator)**ã€‚å®šç¾© LangGraph æµç¨‹ï¼Œä¸²æ¥æ‰€æœ‰æª¢ç´¢èˆ‡ç”Ÿæˆæ­¥é©Ÿã€‚ |
| `app/services/retrieval/` | **`graph_retriever.py`** | **åœ–è­œæª¢ç´¢å·¥å…·**ã€‚è² è²¬è·Ÿ Neo4j æºé€šï¼Œæå–å¯¦é«”èˆ‡æŸ¥è©¢é—œä¿‚ä¸‰å…ƒçµ„ã€‚ |
| `app/services/retrieval/` | **`vector_retriever.py`** | **å‘é‡æª¢ç´¢å·¥å…·**ã€‚è² è²¬è·Ÿ ChromaDB æºé€šï¼ŒåŸ·è¡Œèªæ„æœå°‹ã€‚ |
| `app/services/ingestion/` | **`graph_builder.py`** | **åœ–è­œå»ºç½®å™¨**ã€‚è² è²¬ã€Œå¯«å…¥ã€éšæ®µï¼Œå°‡æ–‡æœ¬è½‰åŒ–ç‚ºåœ–è­œçµæ§‹ã€‚ |
| `app/services/ingestion/` | **`data_loader.py`** | **è³‡æ–™è¼‰å…¥å™¨**ã€‚è² è²¬è®€å–åŸå§‹æª”æ¡ˆä¸¦è½‰ç‚º Document ç‰©ä»¶ (No Chunking)ã€‚ |

### é—œéµåƒæ•¸é€ŸæŸ¥ (Key Parameters)

| éšæ®µ | åƒæ•¸åç¨± | æ•¸å€¼ | èªªæ˜ |
| :--- | :--- | :--- | :--- |
| **æŸ¥è©¢æ“´å±•** | è®Šé«”æ•¸é‡ | **3** | åŠ ä¸ŠåŸå§‹å•é¡Œå…± 4 å€‹ Query |
| **å‘é‡æª¢ç´¢** | Initial Top-K | **30** | æ¯å€‹ Query æ‰¾ 30 ç¯‡ |
| **åœ–è­œæ“´å±•** | Initial Entities | **5** | å¾å‘é‡æ–‡æª”ä¸­æå–çš„å‰ 5 å€‹å¯¦é«” |
| **åœ–è­œæ“´å±•** | Neighbors | **3** | æ¯å€‹å¯¦é«”æ‰¾ 3 å€‹é„°å±… |
| **åœ–è­œæ“´å±•** | è£œå……æª¢ç´¢ K | **2** | æ¯å€‹ã€Œç›¸é—œå¯¦é«”ã€åªæ‰¾ 2 ç¯‡æ–‡æª” |
| **é‡æ’åº** | Rerank Input | **30** | é€²å…¥ LLM æ’åºçš„å€™é¸ä¸Šé™ |
| **é‡æ’åº** | **Final Top-K** | **5** | **æœ€çµ‚çµ¦ç”Ÿæˆçš„æ–‡æª”æ•¸é‡** |
| **åœ–è­œæª¢ç´¢** | Max Entities | **3** | å¾å•é¡Œæå–çš„å¯¦é«”ä¸Šé™ (Direct Graph Search) |
| **åœ–è­œæª¢ç´¢** | Max Relations | **10** | æ¯å€‹å¯¦é«”ä¿ç•™çš„é—œä¿‚ä¸Šé™ |

---

## ğŸ“‹ è©³ç´°æµç¨‹èªªæ˜

### Phase 1: æ•¸æ“šæ”å– (Data Ingestion)

ç•¶åŸ·è¡Œ `python scripts/ingest_corpus.py` æ™‚ï¼š

```python
1. è®€å– data/corpus.json (600ç¯‡æ–‡æª”)
   â†“
2. æ–‡æª”åˆ‡åˆ†èˆ‡å‘é‡åŒ–
   - ä½¿ç”¨ RecursiveCharacterTextSplitter (chunk_size=500)
   - ä½¿ç”¨ text-embedding-3-small ç”Ÿæˆå‘é‡
   - å„²å­˜è‡³ ChromaDB
   â†“
3. å¯¦é«”èˆ‡é—œä¿‚æå–
   - LLM å¾æ–‡æª”ä¸­æå–å¯¦é«” (äººåã€åœ°åã€çµ„ç¹”ç­‰)
   - è­˜åˆ¥å¯¦é«”é–“é—œä¿‚ (has_mother, married_to ç­‰)
   - å„²å­˜è‡³ Neo4j çŸ¥è­˜åœ–è­œ
   â†“
4. Metadata ç¶å®š
   - æ¯å€‹æ–‡æª” chunk é™„å¸¶: doc_id, entities, source_dataset
```

**è¼¸å‡º**ï¼š
- `chroma_db_corpus/`: å‘é‡è³‡æ–™åº«
- Neo4j çŸ¥è­˜åœ–è­œ: å¯¦é«”èˆ‡é—œä¿‚

---

### Phase 2: å•ç­”æµç¨‹ (Question Answering)

ç•¶ç”¨æˆ¶æå•æ™‚ï¼Œç³»çµ±åŸ·è¡Œ 6 å€‹ç¯€é» (LangGraph StateGraph)ï¼š

#### **ç¯€é» 1: Query Expansion**
```python
Input: "Peter Phillips çš„ç¹¼çˆ¶æ˜¯èª°ï¼Ÿ"
    â†“
LLM Prompt: "å°‡æ­¤å•é¡Œåˆ†è§£ç‚ºå¤šå€‹å­å•é¡Œæˆ–è®Šé«”ï¼Œå¾ä¸åŒè§’åº¦æŸ¥è©¢..."
    â†“
Output: [
    "Peter Phillips çš„ç¹¼çˆ¶æ˜¯èª°ï¼Ÿ",  # åŸå•é¡Œ
    "Peter Phillips çš„æ¯è¦ªæ˜¯èª°ï¼Ÿ",  # æ‹†è§£
    "Anne çš„ä¸ˆå¤«æ˜¯èª°ï¼Ÿ"             # é€†å‘
]
```

#### **ç¯€é» 2: Vector Retrieval + Graph Expansion** â­ æ ¸å¿ƒå‰µæ–°

```python
# Step 2.1: åˆå§‹å‘é‡æª¢ç´¢
for query in expanded_queries:
    docs = ChromaDB.search(query, k=30)  # æ¯å€‹æŸ¥è©¢å–30ç¯‡
    all_candidates += docs
    
    # æå–æ–‡æª”ä¸­çš„å¯¦é«”
    for doc in docs:
        initial_entities.add(doc.metadata["entities"])

# Step 2.2: åœ–è­œæ“´å±•
related_entities = Neo4j.get_related_entities(
    initial_entities[:5],  # å–å‰5å€‹å¯¦é«”
    max_neighbors=3        # æ¯å€‹å¯¦é«”æœ€å¤š3å€‹é„°å±…
)

# Step 2.3: å¯¦é«”æª¢ç´¢
for entity in related_entities[:5]:
    entity_docs = ChromaDB.search(entity, k=2)  # æ¯å€‹å¯¦é«”å–2ç¯‡
    all_candidates += entity_docs

    all_candidates += entity_docs

# Output: 30 ç¯‡å€™é¸æ–‡æª” (ç¶“é Top-30 é™åˆ¶)
```

**ç‚ºä»€éº¼é€™æ­¥é‡è¦ï¼Ÿ**  
å¦‚æœåˆå§‹æª¢ç´¢åªæ‰¾åˆ° "Peter" çš„æ–‡æª”ï¼Œä½†æ¼æ‰ "Timothy"ï¼Œåœ–è­œæœƒå‘Šè¨´æˆ‘å€‘ï¼š
```
Peter --[has_mother]--> Anne --[married_to]--> Timothy
```
ç„¶å¾Œä¸»å‹•å»æ‰¾ Timothy çš„æ–‡æª”ï¼

#### **ç¯€é» 3: Reranking**
```python
Input: 30 ç¯‡å€™é¸æ–‡æª”
    â†“
LLM Prompt: "ä½ æ˜¯æ–‡æª”æ’åºå°ˆå®¶ã€‚å¾ä»¥ä¸‹æ–‡æª”ä¸­é¸å‡ºæœ€ç›¸é—œçš„5ç¯‡..."
    â†“
Output: Top-5 æ–‡æª” ID (ä¾‹å¦‚: [1, 5, 3, 12, 8])
```

#### **ç¯€é» 4: Graph Context Retrieval**
```python
# å¾å•é¡Œä¸­æå–å¯¦é«”
entities = extract_entities("Peter Phillips çš„ç¹¼çˆ¶æ˜¯èª°ï¼Ÿ")
    â†“
# å¾ Neo4j æŸ¥è©¢é—œä¿‚
graph_context = [
    "Peter Phillips --[has_mother]--> Anne",
    "Anne --[married_to]--> Timothy Laurence",
    ...
]
```

#### **ç¯€é» 5: Answer Generation**
```python
System Prompt: """
ä½ æ˜¯å°ˆæ¥­å•ç­”åŠ©æ‰‹ï¼Œæ“…é•·å¤šæ­¥é©Ÿæ¨ç†ã€‚

ç­–ç•¥ï¼š
1. åˆ†æå•é¡Œéœ€è¦å¹¾å€‹æ­¥é©Ÿ
2. å¤šæ­¥é©Ÿå•é¡Œä¾åºæ¨ç†ï¼š
   - ç¬¬1æ­¥: æ‰¾èµ·é»è³‡è¨Š (Peter)
   - ç¬¬2æ­¥: æ‰¾ä¸­é–“è³‡è¨Š (Anne)
   - ç¬¬3æ­¥: æ‰¾æœ€çµ‚ç­”æ¡ˆ (Timothy)
3. å°æ–¼æ•¸å€¼å•é¡Œï¼Œæ³¨æ„äº’è£œæ¦‚å¿µè½‰æ›
4. æ•´åˆæ‰€æœ‰è³‡è¨Šå¾—å‡ºçµè«–
"""

Context:
- Top-5 æ–‡æª”å…§å®¹
- Graph Context (å¯¦é«”é—œä¿‚)

Question: "Peter Phillips çš„ç¹¼çˆ¶æ˜¯èª°ï¼Ÿ"
    â†“
Answer: "Peter Phillips çš„ç¹¼çˆ¶æ˜¯ Timothy Laurenceã€‚"
```

---

### Phase 3: è©•ä¼°ç³»çµ± (Evaluation)

åŸ·è¡Œ `curl -X POST http://localhost:8000/evaluate_corpus_detailed?limit=60&k=5`

#### è©•ä¼°æŒ‡æ¨™

| æŒ‡æ¨™ | å®šç¾© | è¨ˆç®—æ–¹å¼ | ç›®æ¨™å€¼ |
|------|------|---------|--------|
| **Hit Rate** | è‡³å°‘æ‰¾åˆ°1ç¯‡é»ƒé‡‘æ–‡æª”çš„å•é¡Œæ¯”ä¾‹ | `å‘½ä¸­å•é¡Œæ•¸ / ç¸½å•é¡Œæ•¸` | 100% |
| **Partial Hit Rate** | å¹³å‡æ‰¾åˆ°çš„é»ƒé‡‘æ–‡æª”æ¯”ä¾‹ | `âˆ‘(æ‰¾åˆ°æ•¸/é»ƒé‡‘ç¸½æ•¸) / ç¸½å•é¡Œæ•¸` | **â‰¥95%** |
| **MRR** | é»ƒé‡‘æ–‡æª”æ’åå€’æ•¸çš„å¹³å‡å€¼ | `âˆ‘(1/é¦–å€‹é»ƒé‡‘æ’å) / ç¸½å•é¡Œæ•¸` | **â‰¥0.75** |
| **Generation Pass Rate** | LLM-as-a-Judge åˆ¤å®šæ­£ç¢ºçš„æ¯”ä¾‹ | `é€šéæ•¸ / ç¸½å•é¡Œæ•¸` | **â‰¥90%** |

#### è©•ä¼°æµç¨‹

```python
for question in queries:
    # 1. RAG æª¢ç´¢èˆ‡ç”Ÿæˆ
    retrieved_docs = rag_system.retrieve(question, k=5)
    model_answer = rag_system.generate(question, retrieved_docs)
    
    # 2. è¨ˆç®—æª¢ç´¢æŒ‡æ¨™
    hit = len(set(retrieved_docs) & set(gold_docs)) > 0
    partial = len(set(retrieved_docs) & set(gold_docs)) / len(gold_docs)
    mrr = 1 / first_gold_rank if found else 0
    
    # 3. LLM-as-a-Judge
    judge_prompt = f"""
    å•é¡Œ: {question}
    æ¨™æº–ç­”æ¡ˆ: {gold_answer}
    æ¨¡å‹ç­”æ¡ˆ: {model_answer}
    
    åˆ¤æ–·æ¨¡å‹ç­”æ¡ˆæ˜¯å¦æ­£ç¢ºï¼Ÿ(Pass/Fail)
    """
    judge_result = llm.invoke(judge_prompt)
```

#### è©•ä¼°çµæœç¯„ä¾‹

```json
{
  "overall": {
    "total_questions": 60,
    "hit_rate": 1.0,
    "partial_hit_rate": 0.932,
    "mrr": 0.751,
    "generation_pass_rate": 0.917
  },
  "by_question_type": {
    "single-hop": {
      "partial_hit_rate": 1.0,
      "mrr": 0.91,
      "generation_pass_rate": 0.95
    },
    "multi-hop": {
      "partial_hit_rate": 0.89,
      "mrr": 0.68,
      "generation_pass_rate": 0.90
    }
  }
}
```

---

## ï¿½ å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

- Python 3.9+
- Neo4j 4.4+ (æœ¬åœ°æˆ–é›²ç«¯)
- OpenAI API Key

### å®‰è£æ­¥é©Ÿ

```bash
# 1. Clone å°ˆæ¡ˆ
git clone <repo-url>
cd Graphrag1

# 2. å»ºç«‹è™›æ“¬ç’°å¢ƒ
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. å®‰è£ä¾è³´
pip install -r requirements.txt

# 4. è¨­å®šç’°å¢ƒè®Šæ•¸
cp .env.example .env
# ç·¨è¼¯ .env å¡«å…¥ä½ çš„ API Keys
```

### ç’°å¢ƒè®Šæ•¸è¨­å®š (.env)

```bash
# OpenAI
OPENAI_API_KEY=sk-...

# Neo4j
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your-password

# Langfuse (å¯é¸)
LANGFUSE_PUBLIC_KEY=pk-...
LANGFUSE_SECRET_KEY=sk-...
LANGFUSE_HOST=https://cloud.langfuse.com
```

### å•Ÿå‹•ç³»çµ±

```bash
# æ–¹å¼ 1: ä½¿ç”¨è…³æœ¬ (æ¨è–¦)
./run.sh

# æ–¹å¼ 2: æ‰‹å‹•å•Ÿå‹•
uvicorn app.main:app --reload
```

è¨ªå•ï¼š`http://localhost:8000/static/index.html`

---

## ğŸ’» ä½¿ç”¨æŒ‡å—

### 1. è³‡æ–™åŒ¯å…¥

#### Web UI (æ¨è–¦)
1. è¨ªå• `http://localhost:8000/static/index.html`
2. åˆ‡æ›åˆ°ã€Œç³»çµ±ç®¡ç†ã€Tab
3. é¸æ“‡åŒ¯å…¥æ•¸é‡ (å»ºè­°å…ˆè©¦ 10 ç¯‡)
4. é»æ“Šã€Œé–‹å§‹åŒ¯å…¥ã€
5. ç­‰å¾…é€²åº¦å®Œæˆ

#### å‘½ä»¤åˆ—
```bash
# åŒ¯å…¥ 10 ç¯‡æ¸¬è©¦
python scripts/ingest_corpus.py --limit 10

# åŒ¯å…¥å…¨éƒ¨ 600 ç¯‡
python scripts/ingest_corpus.py

# æŸ¥çœ‹å¹«åŠ©
python scripts/ingest_corpus.py --help
```

**æ³¨æ„**ï¼šé¦–æ¬¡åŒ¯å…¥æœƒè¼ƒæ…¢ (å« LLM å‘¼å«æå–å¯¦é«”)ï¼Œç´„ 1-2 åˆ†é˜/10 ç¯‡ã€‚

---

### 2. å•ç­”æ¸¬è©¦

#### Web UI
1. åœ¨é¦–é ã€Œå•ç­”æ¸¬è©¦ã€Tab è¼¸å…¥å•é¡Œ
2. é»æ“Šã€Œé€å‡ºã€
3. æŸ¥çœ‹ç­”æ¡ˆèˆ‡æª¢ç´¢åˆ°çš„æ–‡æª”

#### API
```bash
curl -X POST "http://localhost:8000/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {"role": "user", "content": "å°ç£æ–¼ä½•å¹´é–‹å§‹å¯¦æ–½ä¹å¹´åœ‹æ°‘ç¾©å‹™æ•™è‚²?"}
    ]
  }'
```

#### ç¯„ä¾‹å•é¡Œ
ç³»çµ±æ”¯æ´å¤šç¨®é¡å‹å•é¡Œï¼ŒåŒ…æ‹¬ï¼š
- äº‹å¯¦æŸ¥è©¢ (å–®è·³å•é¡Œ)
- é—œä¿‚æ¨ç† (å¤šè·³å•é¡Œ)
- æ•¸å€¼è¨ˆç®— (æ¯”ä¾‹è½‰æ›)

---

### 3. åŸ·è¡Œè©•ä¼°

#### Web UI
1. åˆ‡æ›åˆ°ã€Œè©•ä¼°åŸ·è¡Œã€Tab
2. é¸æ“‡è©•ä¼°æ•¸é‡ (5 / 20 / 60 é¡Œ)
3. è¨­å®š Top-K (å»ºè­° 5)
4. é»æ“Šã€Œé–‹å§‹è©•ä¼°ã€
5. æŸ¥çœ‹çµæœè¡¨æ ¼èˆ‡åœ–è¡¨

#### API
```bash
# å°è¦æ¨¡æ¸¬è©¦ (5é¡Œ)
curl -X POST "http://localhost:8000/evaluate_corpus_detailed?limit=5&k=5"

# å®Œæ•´è©•ä¼° (60é¡Œ)
curl -X POST "http://localhost:8000/evaluate_corpus_detailed?limit=60&k=5"
```

#### å‘½ä»¤åˆ—
```bash
python scripts/evaluate_corpus.py --limit 20 --k 5
```

è©•ä¼°çµæœå„²å­˜åœ¨ `docs/evaluation_results_[timestamp].json`

---

### 4. ç³»çµ±çµ±è¨ˆ

```bash
# API
curl http://localhost:8000/corpus_stats

# è¼¸å‡ºç¯„ä¾‹
{
  "vector_store": {
    "total_documents": 600,
    "total_chunks": 1234
  },
  "graph_store": {
    "total_nodes": 4567,
    "total_relationships": 8901
  }
}
```

---

## ğŸ“Š è©•ä¼°ç³»çµ±

### å®Œæ•´è©•ä¼°å·¥ä½œæµç¨‹

```
è¼‰å…¥ data/queries.json (60é¡Œ)
    â†“
éæ¿¾åˆ°æŒ‡å®šæ•¸é‡ (limit)
    â†“
For æ¯å€‹å•é¡Œ:
  1. åŸ·è¡Œ RAG æª¢ç´¢ (Top-K)
  2. ç”Ÿæˆç­”æ¡ˆ
  3. è¨ˆç®—æª¢ç´¢æŒ‡æ¨™ (Hit, Partial, MRR)
  4. LLM-as-a-Judge è©•åˆ†
  5. è¨˜éŒ„æ™‚é–“
    â†“
èšåˆçµæœ
  - Overall æŒ‡æ¨™
  - By Source (drcd/hotpotqa/2wiki)
  - By Type (single-hop/multi-hop)
    â†“
å„²å­˜ JSON + è¿”å› API
```

### LLM-as-a-Judge æ©Ÿåˆ¶

```python
Judge Prompt = """
ä½ æ˜¯ä¸€å€‹åš´è¬¹çš„è©•åˆ†å“¡ã€‚åˆ¤æ–·æ¨¡å‹ç­”æ¡ˆæ˜¯å¦æ­£ç¢ºã€‚

è©•åˆ†æ¨™æº–ï¼š
- âœ… Pass: æ ¸å¿ƒäº‹å¯¦ä¸€è‡´ (å…è¨±èªæ„ç›¸ä¼¼ã€ç¿»è­¯ã€é¡å¤–ç´°ç¯€)
- âŒ Fail: æ ¸å¿ƒäº‹å¯¦çŸ›ç›¾æˆ–å®Œå…¨ç„¡ç›¸é—œè³‡è¨Š

å•é¡Œ: {question}
æ¨™æº–ç­”æ¡ˆ: {gold_answer}
æ¨¡å‹ç­”æ¡ˆ: {model_answer}

åˆ¤æ–·: Pass æˆ– Fail
"""
```

---

## ğŸ› ï¸ æŠ€è¡“æ£§

### å¾Œç«¯
- **FastAPI**: Web æ¡†æ¶
- **LangGraph**: å·¥ä½œæµç·¨æ’
- **LangChain**: LLM æ•´åˆ
- **Pydantic**: è³‡æ–™é©—è­‰

### è³‡æ–™åº«
- **ChromaDB**: å‘é‡è³‡æ–™åº«
- **Neo4j**: åœ–è­œè³‡æ–™åº«

### AI/ML
- **OpenAI GPT-4o-mini**: LLM
- **text-embedding-3-small**: Embedding

### ç›£æ§
- **Langfuse**: LLM å‘¼å«è¿½è¹¤ (å¯é¸)

### å‰ç«¯
- **Vanilla HTML/CSS/JS**: ç„¡æ¡†æ¶ä¾è³´

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
Graphrag1/
â”œâ”€â”€ app/                          # æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒ
â”‚   â”œâ”€â”€ main.py                   # FastAPI ä¸»ç¨‹å¼
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py             # ç’°å¢ƒé…ç½®
â”‚   â”‚   â””â”€â”€ langfuse_helper.py    # Langfuse æ•´åˆ
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ vector_store.py       # ChromaDB ç®¡ç†
â”‚   â”‚   â””â”€â”€ graph_store.py        # Neo4j ç®¡ç†
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ schemas.py            # API Schema
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ ingestion/
â”‚       â”‚   â””â”€â”€ graph_builder.py  # å¯¦é«”é—œä¿‚æå–
â”‚       â”œâ”€â”€ retrieval/
â”‚       â”‚   â”œâ”€â”€ vector_retriever.py
â”‚       â”‚   â””â”€â”€ graph_retriever.py
â”‚       â”œâ”€â”€ rag/
â”‚       â”‚   â””â”€â”€ graph_rag.py      # â­ LangGraph å·¥ä½œæµ
â”‚       â”œâ”€â”€ evaluation/
â”‚       â”‚   â”œâ”€â”€ evaluator.py      # è©•ä¼°åŸ·è¡Œå™¨
â”‚       â”‚   â””â”€â”€ metrics.py        # æŒ‡æ¨™è¨ˆç®—
â”‚       â””â”€â”€ service_layer.py      # æœå‹™å±¤æ•´åˆ
â”‚
â”œâ”€â”€ scripts/                      # CLI å·¥å…·
â”‚   â”œâ”€â”€ ingest_corpus.py          # è³‡æ–™åŒ¯å…¥
â”‚   â”œâ”€â”€ evaluate_corpus.py        # è©•ä¼°åŸ·è¡Œ
â”‚   â””â”€â”€ clear_neo4j.py            # æ¸…ç†åœ–è­œ
â”‚
â”œâ”€â”€ data/                         # è³‡æ–™æª”æ¡ˆ
â”‚   â”œâ”€â”€ corpus.json               # 600 ç¯‡æ–‡æª”
â”‚   â””â”€â”€ queries.json              # 60 å€‹è©•ä¼°å•é¡Œ
â”‚
â”œâ”€â”€ docs/                         # æ–‡æª”
â”‚   â”œâ”€â”€ USER_GUIDE.md             # è©³ç´°ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ usage_guide(1).md         # è©•ä¼°è¦ç¯„
â”‚   â””â”€â”€ evaluation_results_*.json # è©•ä¼°çµæœ
â”‚
â”œâ”€â”€ static/                       # å‰ç«¯
â”‚   â””â”€â”€ index.html                # Web UI
â”‚
â”œâ”€â”€ chroma_db_corpus/             # å‘é‡è³‡æ–™åº« (è‡ªå‹•ç”Ÿæˆ)
â”œâ”€â”€ .env                          # ç’°å¢ƒè®Šæ•¸
â”œâ”€â”€ requirements.txt              # Python ä¾è³´
â””â”€â”€ README.md                     # â­ æœ¬æ–‡æª”
```

---

## ğŸ”§ å¸¸è¦‹å•é¡Œ (FAQ)

### Q1: ç‚ºä»€éº¼è¦ç”¨ Graph RAGï¼Ÿ
**A**: å‚³çµ± RAG åªé èªç¾©ç›¸ä¼¼åº¦ï¼Œå°æ–¼å¤šè·³å•é¡Œ (ä¾‹å¦‚ã€ŒAçš„Bçš„Cæ˜¯Då—ï¼Ÿã€) å®¹æ˜“éºæ¼é—œéµæ–‡æª”ã€‚Graph RAG é€éçŸ¥è­˜åœ–è­œå»ºç«‹å¯¦é«”é—œä¿‚ï¼Œèƒ½ä¸»å‹•ç™¼ç¾éš±å«çš„é—œè¯ã€‚

### Q2: Partial Hit Rate vs Hit Rate æœ‰ä»€éº¼å·®åˆ¥ï¼Ÿ
**A**:
- **Hit Rate**: åªè¦æ‰¾åˆ° â‰¥1 ç¯‡é»ƒé‡‘æ–‡æª”å°±ç®—å‘½ä¸­ (äºŒå…ƒæŒ‡æ¨™)
- **Partial Hit Rate**: è¨ˆç®—æ‰¾åˆ°çš„é»ƒé‡‘æ–‡æª”å æ¯” (é€£çºŒæŒ‡æ¨™ï¼Œæ›´åš´æ ¼)

ä¾‹å¦‚é»ƒé‡‘æ–‡æª”æœ‰ 2 ç¯‡ï¼š
- æ‰¾åˆ° 1 ç¯‡: Hit Rate=100%, Partial=50%
- æ‰¾åˆ° 2 ç¯‡: Hit Rate=100%, Partial=100%

### Q3: ç‚ºä»€éº¼éœ€è¦ Query Expansionï¼Ÿ
**A**: ä½¿ç”¨è€…çš„å•æ³•å¯èƒ½è·Ÿæ–‡æª”ç”¨è©ä¸åŒã€‚ä¾‹å¦‚å•ã€Œç¹¼çˆ¶ã€ï¼Œæ–‡æª”å¯èƒ½å¯«ã€Œæ¯è¦ªçš„ä¸ˆå¤«ã€ã€‚Query Expansion é€é LLM ç”Ÿæˆå¤šå€‹èªç¾©ç­‰åƒ¹çš„æŸ¥è©¢ï¼Œæå‡å¬å›ç‡ã€‚

### Q4: ç³»çµ±èƒ½è™•ç†ä¸­æ–‡å—ï¼Ÿ
**A**: å®Œå…¨æ”¯æ´ï¼`text-embedding-3-small` å°ä¸­æ–‡æœ‰è‰¯å¥½æ”¯æ´ï¼ŒLLM ä¹Ÿä½¿ç”¨æ”¯æ´ä¸­æ–‡çš„ GPT-4o-miniã€‚

### Q5: å¦‚ä½•æ¸…ç†è³‡æ–™åº«é‡æ–°é–‹å§‹ï¼Ÿ
**A**:
```bash
# æ¸…ç† Neo4j
python scripts/clear_neo4j.py

# æ¸…ç† ChromaDB (éœ€æ‰‹å‹•)
rm -rf chroma_db_corpus/

# é‡æ–°åŒ¯å…¥
python scripts/ingest_corpus.py --limit 10
```

---

## ğŸ“ˆ æ•ˆèƒ½åŸºæº–

åŸºæ–¼ 60 é¡Œè©•ä¼°é›† (DRCD + HotpotQA + 2WikiMultihopQA)ï¼š

| æŒ‡æ¨™ | å„ªåŒ–å‰ | **å„ªåŒ–å¾Œ** | æå‡ |
|------|--------|----------|------|
| Partial Hit Rate | 86.8% | **92.5%** â¬†ï¸ | +5.7% |
| MRR | 0.68 | **0.97** â¬†ï¸ | +29% |
| Generation Pass Rate | 88.3% | **91.7%** â¬†ï¸ | +3.4% |
| Multi-hop Pass Rate | 87.5% | **87.5%** â– | 0% |

**å„ªåŒ–ç­–ç•¥**:
1. âœ… Graph-Guided Retrieval Expansion
2. âœ… Query Expansion with Multi-perspective
3. âœ… LLM Listwise Reranking
4. âœ… Enhanced Multi-step Reasoning Prompt

---

## ğŸ¤ è²¢ç»æŒ‡å—

æ­¡è¿æäº¤ Issue æˆ– Pull Requestï¼

---

## ğŸ“ æˆæ¬Š

Academic Use Only

---

## ğŸ™ è‡´è¬

Built with â¤ï¸ using:
- [LangChain](https://www.langchain.com/)
- [LangGraph](https://langchain-ai.github.io/langgraph/)
- [FastAPI](https://fastapi.tiangolo.com/)
- [Neo4j](https://neo4j.com/)
- [ChromaDB](https://www.trychroma.com/)

---

**æ›´æ–°æ™‚é–“**: 2026-02-08  
**ç‰ˆæœ¬**: 2.0 (Graph Expansion Release)
